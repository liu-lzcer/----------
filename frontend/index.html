<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>动画镜头任务管理系统</title>
    <meta name="color-scheme" content="light" />
  </head>
  <body class="bg-mac-bg text-mac-text">
    <div id="app" x-data="appState()" x-init="init()" class="min-h-screen">
      <header class="sticky top-0 z-30 backdrop-blur bg-white/70 border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto px-4 py-3 flex items-center gap-3">
          <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-yellow-400"></div>
          <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
          <h1 class="ml-3 text-lg font-semibold">镜头任务协作</h1>
          <div class="ml-auto flex items-center gap-3">
            <button @click="openSearch()" class="px-3 py-1.5 rounded-md bg-mac-surface shadow-mac hover:shadow focus:outline-none border border-gray-200 text-sm">
              全局搜索（Ctrl+Space）
            </button>
            <template x-if="user">
              <div class="flex items-center gap-2">
                <span class="text-sm text-mac-muted" x-text="user?.nickname || user?.username"></span>
                <button @click="logout()" class="px-3 py-1.5 rounded-md bg-white border border-gray-200 hover:bg-gray-50 text-sm">退出</button>
              </div>
            </template>
          </div>
        </div>
      </header>

      <div x-show="configError" class="bg-red-50 text-red-700 border border-red-200 mx-auto max-w-screen-2xl mt-4 rounded-md p-3" x-text="configError"></div>

      <section x-show="view === 'login'" class="max-w-md mx-auto mt-24 bg-white rounded-[14px] shadow-mac border border-gray-200 p-6">
        <h2 class="text-xl font-semibold mb-4">登录</h2>
        <form @submit.prevent="login()" class="space-y-4">
          <div>
            <label class="block text-sm mb-1">用户名</label>
            <input x-model="credentials.username" class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-mac-primary" autocomplete="username" />
          </div>
          <div>
            <label class="block text-sm mb-1">密码</label>
            <input type="password" x-model="credentials.password" class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-mac-primary" autocomplete="current-password" />
          </div>
          <button type="submit" class="w-full py-2 rounded-md bg-mac-primary text-white shadow-mac hover:opacity-95" :disabled="loading">
            <span x-show="!loading">登录</span>
            <span x-show="loading">处理中...</span>
          </button>
          <p class="text-sm text-mac-muted" x-text="error"></p>
        </form>
      </section>

      <section x-show="view === 'app'" class="max-w-screen-2xl mx-auto mt-4 px-4">
        <div class="grid grid-cols-12 gap-4">
          <aside class="col-span-3 bg-white rounded-[14px] shadow-mac border border-gray-200 p-3">
            <div class="mb-2">
              <input placeholder="搜索项目" x-model.debounce.300ms="projectQuery" @input="loadProjects()" class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-mac-primary" />
            </div>
            <div class="max-h-[60vh] overflow-auto divide-y">
              <template x-for="p in projects" :key="p.id">
                <button class="w-full text-left px-2 py-2 hover:bg-gray-50 rounded-md" :class="{'bg-gray-50': p.id===selectedProjectId}" @click="selectProject(p.id)">
                  <div class="text-sm font-medium" x-text="p.name"></div>
                  <div class="text-xs text-mac-muted" x-text="p.description"></div>
                </button>
              </template>
              <div x-show="projects.length===0" class="text-sm text-mac-muted px-2 py-3">无项目可显示</div>
            </div>
          </aside>

          <main class="col-span-6 bg-white rounded-[14px] shadow-mac border border-gray-200 p-3">
            <div class="flex flex-wrap items-center gap-2 mb-3">
              <input placeholder="搜索镜头号/标题" x-model.debounce.300ms="filters.q" @input="loadTasks()" class="rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-mac-primary" />
              <select x-model="filters.stage" @change="loadTasks()" class="rounded-md border border-gray-300 px-2 py-2 text-sm">
                <option value="">环节</option>
                <template x-for="s in sets.stages" :key="s"><option :value="s" x-text="s"></option></template>
              </select>
              <select x-model="filters.status" @change="loadTasks()" class="rounded-md border border-gray-300 px-2 py-2 text-sm">
                <option value="">状态</option>
                <template x-for="s in sets.statuses" :key="s"><option :value="s" x-text="s"></option></template>
              </select>
            </div>
            <div class="overflow-auto border rounded-lg">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50 text-gray-600">
                  <tr>
                    <th class="px-3 py-2 text-left">镜头号</th>
                    <th class="px-3 py-2 text-left">标题</th>
                    <th class="px-3 py-2">环节</th>
                    <th class="px-3 py-2">负责人</th>
                    <th class="px-3 py-2">状态</th>
                    <th class="px-3 py-2">截止</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="t in tasks" :key="t.id">
                    <tr class="border-t hover:bg-gray-50 cursor-pointer" @click="selectTask(t.id)">
                      <td class="px-3 py-2" x-text="t.shotNo"></td>
                      <td class="px-3 py-2" x-text="t.title"></td>
                      <td class="px-3 py-2 text-center" x-text="t.stage"></td>
                      <td class="px-3 py-2 text-center" x-text="t.assignee?.nickname || '-' "></td>
                      <td class="px-3 py-2 text-center">
                        <span class="px-2 py-0.5 rounded text-xs border" :class="statusBadgeClass(t.status)" x-text="t.status"></span>
                      </td>
                      <td class="px-3 py-2 text-center" x-text="t.dueDate ? (new Date(t.dueDate)).toLocaleDateString() : '-' "></td>
                    </tr>
                  </template>
                  <tr x-show="tasks.length===0">
                    <td colspan="6" class="px-3 py-6 text-center text-mac-muted">暂无任务</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </main>

          <aside class="col-span-3 bg-white rounded-[14px] shadow-mac border border-gray-200 p-3">
            <template x-if="!selectedTask">
              <div class="text-mac-muted text-sm">选择左侧任务以查看详情</div>
            </template>
            <template x-if="selectedTask">
              <div class="space-y-3">
                <div>
                  <div class="font-medium" x-text="selectedTask?.title"></div>
                  <div class="text-xs text-mac-muted" x-text="'镜头号：' + (selectedTask?.shotNo || '-')"></div>
                </div>
                <div class="flex gap-2 text-xs">
                  <span class="px-2 py-0.5 rounded bg-gray-100 border" x-text="selectedTask?.stage"></span>
                  <span class="px-2 py-0.5 rounded bg-gray-100 border" x-text="selectedTask?.status"></span>
                </div>
                <div>
                  <h3 class="text-sm font-semibold mb-1">最新文件</h3>
                  <div class="text-sm text-mac-muted" x-text="latestVersionSummary"></div>
                </div>
                <div>
                  <h3 class="text-sm font-semibold mb-1">历史版本</h3>
                  <div class="max-h-40 overflow-auto divide-y">
                    <template x-for="v in versions" :key="v.versionNo">
                      <div class="py-2 text-sm flex items-center justify-between">
                        <span x-text="'v' + v.versionNo"></span>
                        <button class="text-mac-primary hover:underline" @click="downloadVersion(v)">下载</button>
                      </div>
                    </template>
                    <div x-show="versions.length===0" class="text-sm text-mac-muted py-2">暂无历史版本</div>
                  </div>
                </div>
                <div>
                  <h3 class="text-sm font-semibold mb-1">备注</h3>
                  <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="selectedTask?.remark || '—'"></p>
                </div>
                <div>
                  <h3 class="text-sm font-semibold mb-1">评论</h3>
                  <div class="max-h-40 overflow-auto divide-y mb-2">
                    <template x-for="c in comments" :key="c.id">
                      <div class="py-2 text-sm">
                        <div class="text-xs text-mac-muted" x-text="c.author?.nickname + ' · ' + (new Date(c.createdAt)).toLocaleString()"></div>
                        <div x-text="c.content"></div>
                      </div>
                    </template>
                    <div x-show="comments.length===0" class="text-sm text-mac-muted py-2">暂无评论</div>
                  </div>
                  <form @submit.prevent="submitComment()" class="flex gap-2">
                    <input x-model="newComment" placeholder="写评论..." class="flex-1 rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-mac-primary" />
                    <button type="submit" class="px-3 py-2 rounded-md bg-mac-primary text-white">发布</button>
                  </form>
                </div>
              </div>
            </template>
          </aside>
        </div>
      </section>

      <div x-show="searchOpen" x-transition @keydown.escape.window="searchOpen=false" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-start justify-center pt-24">
        <div class="w-[720px] bg-white rounded-[14px] shadow-mac border border-gray-200 p-4" @click.outside="searchOpen=false">
          <input x-model.debounce.200ms="searchQuery" @input="doSearch()" placeholder="输入搜索... 支持 p:/t:/a:/u:/c:/v:" class="w-full rounded-md border border-gray-300 px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-mac-primary" />
          <div class="max-h-80 overflow-auto divide-y">
            <template x-for="group in searchResults" :key="group.title">
              <div class="py-2">
                <div class="text-xs text-mac-muted mb-1" x-text="group.title"></div>
                <template x-for="item in group.items" :key="item.id">
                  <button class="block w-full text-left px-2 py-1.5 rounded hover:bg-gray-50" @click="navigateSearchResult(item)">
                    <div class="text-sm" x-text="item.label"></div>
                    <div class="text-xs text-mac-muted" x-text="item.subtitle"></div>
                  </button>
                </template>
              </div>
            </template>
            <div x-show="searchResults.length===0" class="text-sm text-mac-muted py-3">无结果</div>
          </div>
        </div>
      </div>

      <div @keydown.window.prevent="if ($event.ctrlKey && $event.code==='Space') { openSearch(); }"></div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
  </html>


