## 动画镜头任务管理系统｜功能需求说明（instruction.md）

### 文档目的

- 明确系统范围、目标用户、核心能力、非功能性要求、技术栈选择。
- 为需求评审与验收提供统一依据。

### 系统概述

- 部署目标：基于群晖 NAS 的镜头任务协作平台，提供登录、项目与任务管理、双通道文件上传、版本留存、备注附件、评论交流、通知提醒。
- 架构形态：前后端分离；前端为静态资源；后端为 RESTful API 服务；所有数据与文件存储于 NAS 本地。
- UI 目标：macOS 风格；浅色主题；圆角卡片；拟态阴影；高对比可读性；动效轻量。

### 用户角色与权限

- 角色定义：

  - 管理员（Admin）：系统配置、用户管理、项目管理、任务全量编辑、文件版本管理、评论治理、全量可见。
  - 导演/制片（Director/Producer）：项目创建；所负责项目内的任务创建与指派与状态流转与备注维护与文件上传与评论参与；全量可见。
  - 艺术家（Artists）：仅能查看被分配任务；允许上传本人任务文件；允许下载历史版本；允许参与评论；禁止编辑任务字段。
- 权限矩阵（✔ 允许；✖ 禁止）

| 功能项          | 管理员 | 导演/制片 | 艺术家             |
| --------------- | ------ | --------- | ------------------ |
| 登录/退出       | ✔     | ✔        | ✔                 |
| 浏览参与项目    | ✔     | ✔        | ✔（仅被分配任务） |
| 新增项目        | ✔     | ✔        | ✖                 |
| 编辑/删除项目   | ✔     | ✖        | ✖                 |
| 新建任务        | ✔     | ✔        | ✖                 |
| 编辑任务字段    | ✔     | 受限      | ✖                 |
| 指派/更改负责人 | ✔     | ✔        | ✖                 |
| 删除任务        | ✔     | ✖        | ✖                 |
| 上传任务文件    | ✔     | ✔        | ✔（限本人任务）   |
| 下载任务文件    | ✔     | ✔        | ✔（仅被分配任务） |
| 查看历史版本    | ✔     | ✔        | ✔（仅被分配任务） |
| 删除文件版本    | ✔     | ✖        | ✖                 |
| 评论发布        | ✔     | ✔        | ✔                 |
| 删除他人评论    | ✔     | ✖        | ✖                 |
| 处理通知        | ✔     | 项目相关  | 任务相关           |
| 全局搜索与跳转  | ✔     | ✔        | ✔                 |
| 系统配置        | ✔     | ✖        | ✖                 |

说明：导演/制片“受限”表示仅能修改状态与备注；艺术家仅可见被分配任务且不得编辑任务字段。

### 功能需求

#### 1) 认证与会话

- 必须提供用户名密码登录；登录失败返回明确原因；密码以安全哈希保存（存储细节不在本文范围）。
- 必须提供登出；会话立即失效。
- 会话维持基于 Cookie；同一账户并发登录策略由后台配置统一裁定。

#### 2) 项目管理

- 列表：展示当前用户可见项目；支持按名称搜索；支持归档折叠。
- 新增：仅管理员；输入名称、描述；系统生成唯一标识；在 NAS 建立项目目录。
- 编辑：仅管理员；允许更新名称、描述、归档状态。
- 删除：仅管理员；危险操作需二次确认；删除前需处理下属任务。

#### 3) 镜头任务管理

- 列表呈现字段：镜头号、标题、环节、负责人、状态、截止日期、最后更新时间、备注摘要。
- 过滤与搜索：按镜头号、标题关键字；按环节、负责人、状态多条件组合过滤；支持列排序。
- 新建任务：管理员与导演/制片；校验镜头号在项目内唯一；环节与状态取自 sets.json；初始化任务目录。
- 更新任务：管理员可更新全部字段；导演/制片可更新状态与备注；艺术家禁止字段编辑。
- 删除任务：仅管理员；危险操作需二次确认。

#### 4) 文件上传与管理

- 文件类型：
  - 预览视频：MP4、MOV；编码要求 H.264 视频、AAC 音频；浏览器可直接播放。
  - 工程源文件：ZIP 容器；内部格式不限；团队规范另行约定。
- 上传入口：视频入口独立；工程入口独立；任一入口均可单独触发版本更新；同一版本可一次性完成双文件上传。
- 存储布局：任务根目录下建立 versions 子目录；每次上传生成 vN 目录；内部命名固定为 preview.mp4（或 .mov）、project.zip；附件另见“备注附件”。
- 权限：管理员与导演/制片与任务被指派艺术家允许上传；越权拒绝。
- 下载：任意可见用户可下载最新文件与历史版本；支持“下载全部”（同一版本打包 ZIP）。

#### 5) 备注附件

- 每个任务仅关联一个备注附件；文件类型 ZIP；文件名固定为 remark.zip；存放于 attachments 子目录。
- 更新备注附件不触发文件版本号递增；更新完成后“最后更新时间”刷新。
- 艺术家仅浏览与下载；管理员与导演/制片允许替换附件与编辑备注文本。

#### 6) 评论交流

- 评论元素：作者、时间、文本内容、图片附件（最多 1 张，PNG/JPG/JPEG）。
- 列表呈现倒序；长文本折叠；图片缩略图展示，点击放大。
- 权限：项目可见性生效；相关成员均可发言；管理员具备删除不当评论权限；作者允许在短时间窗口内撤销本人评论。

#### 7) 版本管理

- 版本号：从 1 递增；每次文件上传至少包含一项文件即产生新版本；系统自动分配号段；不可回收复用。
- 历史：完整保留；前端展示“最新文件”与“历史版本”；支持预览历史视频与下载历史工程包与“下载全部”。
- 回退策略：通过再次上传旧版内容形成新版本实现回退；禁止破坏历史链路的直接覆盖。

#### 8) 通知提醒

- 通知类型：站内通知、邮件通知、浏览器桌面通知。
- 触发场景：任务指派；文件新版本上传；新评论发布。
- 目标用户：导演/制片与被指派艺术家与管理员（依据事件类型）。
- 站内通知：实时推送；通知中心展示未读提示；支持已读管理。
- 邮件通知：使用组织提供的 SMTP 配置；模板包含事件摘要、链接。
- 桌面通知：基于浏览器通知权限；点击跳转目标任务。

#### 9) 全局配置（sets.json）

- 用途：集中维护环节列表、状态列表、下拉框字典项；前端初始化通过后端公开读取接口完成。
- 权限：仅管理员允许更新；更新前进行结构校验；更新后立即生效。
- 一致性：前端展现选项必须与后端校验规则一致；禁止绕过。

#### 10) 前端界面与交互

- 布局：三栏结构；左侧项目侧栏；中部任务表格与筛选工具栏；右侧任务详情面板（文件、版本、备注、评论）。
- 交互：点击任务行切换右侧详情；筛选项即时生效；上传展示进度条；历史版本折叠展开；通知中心覆盖层展示。
- 可用性：键盘可达；较大点击热区；清晰状态色标（完成：绿色；进行中：黄色；待开始：灰色；审核中：蓝色）。

#### 11) 资产任务管理

- 定义：资产任务用于项目前期资料与素材的生产与整理；功能与镜头任务一致；数据域独立。
- 列表呈现字段：标题、资产类别、环节、负责人、状态、截止日期、最后更新时间、备注摘要。
- 过滤与搜索：按标题关键字检索；按资产类别与环节与负责人与状态过滤；支持列排序。
- 新建资产任务：管理员与导演/制片可创建；标题在项目内唯一；环节与状态取自 sets.json；系统初始化资产任务目录。
- 更新资产任务：管理员可更新全部字段；导演/制片可更新状态与备注；艺术家禁止字段编辑。
- 删除资产任务：仅管理员；危险操作需二次确认。
- 文件上传：
  - 资产文件上传：允许 PNG、JPG、JPEG、WEBP、PSD、AI、SVG、ZIP、BLEND、FBX；生成新版本。
  - 审阅媒体上传：仅允许 PNG、JPG、JPEG、WEBP、MP4、MOV；图片以灯箱呈现；视频以播放器呈现；生成新版本。
  - 工程文件上传：仅允许 ZIP；生成新版本。
- 版本管理：资产任务拥有独立版本号序列；从 1 递增；历史完整保留；“下载全部”包含该版本的资产文件与审阅媒体与工程文件。
- 评论与通知：沿用评论模块与通知模块；范围限定为资产任务所属项目与相关成员。
- 数据隔离：资产任务列表与文件目录与版本记录与评论记录与通知记录与镜头任务互不交叉。

#### 12) 视频审阅与时码批注

- 适用范围：
  - 镜头任务的视频预览。
  - 资产任务的审阅媒体视频。
- 播放器区域：
  - 显示时码；支持拖动进度条定位；支持跳转到指定时码。
  - 播放控制：播放、暂停、静音、音量、倍速、清晰度选择。
- 批注输入：
  - 视频下方提供“写批注”输入框；提交时绑定当前时码；在列表显示该时码。
  - 可见范围设置：
    - 所有人可见。
    - 项目成员可见。
  - 仅相关成员可见（管理员与导演/制片与被指派艺术家）。
  - 支持@提及用户；被提及用户收到通知。
- 标注工具：
  - 画笔自由描绘。
  - 箭头指向标记。
  - 矩形区域高亮。
  - 文字批注框。
  - 颜色预设与线条粗细档位与撤销与重做与清除。
- 批注展示区：
  - 右侧独立列表呈现；按时间倒序；显示头像与用户名与创建时间与时码与文本摘要与标注缩略图。
  - 点击条目跳转至对应时码并显示叠加标注。
  - 过滤视图：全部与未读与我的；提供关键字搜索。
  - 状态流转：打开与已解决；已解决项折叠显示。
- 权限与治理：
  - 创建权限：项目参与者均可创建批注。
  - 编辑撤销：作者在短时窗口内允许撤销与编辑文本与标注；超时后仅管理员可修改。
  - 删除权限：管理员可删除任意批注；导演/制片可删除负责项目内不当批注；艺术家不可删除他人批注。
- 导出与留存：
  - 批注导出：Word 与 Excel 与 PDF。
  - 导出包含截图缩略图与时码与批注文本与作者与时间与状态。
- 通知联动：
  - 新批注创建时通知导演/制片与被提及用户与管理员。
  - 批注状态变化时通知涉及用户。

#### 13) 全局搜索与快速跳转

- 呼出方式：按下 ⌘+Space（macOS）或 Ctrl+Space（Windows）唤起全局搜索面板；输入即搜即显。
- 索引范围：项目名称与镜头任务标题与镜头号与资产任务标题与用户昵称与版本号与评论文本摘要与批注文本摘要。
- 结果分组：项目与镜头任务与资产任务与用户与评论/批注与版本文件；每组最多显示 5 条，支持 Tab 在分组间切换。
- 跳转目标：
  - 选中项目：进入项目主页并聚焦任务表格。
  - 选中镜头任务或资产任务：进入任务详情并高亮命中字段。
  - 选中评论/批注：进入任务详情并定位到评论区或对应时码。
  - 选中版本文件：进入任务详情并定位到对应版本。
- 搜索语法：
  - 前缀过滤：p: 项目，t: 任务，a: 资产，u: 用户，c: 评论，v: 版本。
  - 逻辑：支持空格多词 AND；支持引号执行精确匹配；支持 #tag 标签。
- 权限与可见性：仅返回当前用户可见的数据；艺术家仅检索到被分配任务与其可见评论/批注。
- 性能与体验：300ms 内返回首屏；键盘上下选择与回车跳转；Esc 关闭。

### 非功能性需求

- 安全性：

  - 全站 HTTPS；Cookie 标记 Secure、HttpOnly、SameSite=Strict。
  - 身份鉴别覆盖所有接口；访问控制基于角色与对象归属；最小权限原则。
  - 文件名白名单策略；拒绝路径穿越；服务端完成 MIME 校验。
- 性能与容量：

  - 并发用户规模：小团队日常使用等级；关键交互无明显卡顿。
  - 大文件上传采用流式保存；视频播放使用断点续传能力；版本下载打包延迟可接受。
- 兼容性：

  - 浏览器：Chromium 内核、Safari、Firefox 的近三个大版本。
  - 操作系统：macOS、Windows 的受支持稳定版本。
- 可维护性：

  - 前后端松耦合；接口契约稳定；日志记录关键操作；错误信息清晰可读。
- 部署与运维约束：

  - 前端：Vite 构建产物部署至 NAS Web Station 指定目录；静态托管。
  - 后端：常驻进程；监听专用端口（示例 8000）；通过反向代理暴露统一域名下的 /api 路径；仅开放必要端口。
  - 存储：项目根共享目录用于文件与数据库文件；定期快照与备份；容量预警。

### 技术栈

- 前端：

  - 构建：Node.js 18 与 Vite。
  - 框架：Alpine.js。
  - 样式：Tailwind CSS。
  - 设计规范：macOS 风格组件与浅色主题。
- 后端：

  - 语言与框架：Python 3.11 与 FastAPI。
  - 运行：Uvicorn。
  - ORM：SQLAlchemy。
  - 会话：基于 Cookie 的会话维持；CSRF 保护。
- 存储与文件：

  - 结构化数据：SQLite（文件型）；具体表结构不在本文范围。
  - 大体积文件：NAS 共享目录；任务分目录；版本化存放。
  - 全局配置：sets.json。
- 通讯与服务：

  - 站内通知：WebSocket 实时推送。
  - 邮件发送：SMTP。
  - 反向代理：Nginx（TLS 终止、路径转发、静态资源缓存）。

### 验收标准（关键用例补充）

- 资产任务

  - 管理员与导演/制片创建资产任务成功；标题唯一；目录初始化完成。
  - 导演/制片仅能更新状态与备注；艺术家尝试编辑被拒绝。
  - 资产文件、审阅媒体、工程文件分别上传任一项即生成新版本；版本号自增；历史可下载与“下载全部”可用。
  - 评论发表成功并与资产任务绑定；相关成员收到站内通知；邮件模板内容正确。
- 视频审阅与时码批注

  - 在播放器下方成功提交批注并绑定正确时码；右侧列表即时出现；点击条目可跳转到对应时码并显示叠加标注。
  - 画笔与箭头与矩形与文字工具可用；颜色与粗细调节有效；支持撤销与重做与清除。
  - 可见范围设置生效：所选范围以外用户在同一任务中看不到该条批注。
  - @提及触发通知；被提及用户在通知中心可见并可跳转。
  - 批注导出生成 Word 与 Excel 与 PDF，内容包含时码与文本与缩略图与作者与时间与状态。
- 全局搜索与快速跳转

  - 使用 ⌘+Space（macOS）或 Ctrl+Space（Windows）呼出；输入“p:”“t:”“a:”“u:”“c:”“v:”可精准筛选；上下选择与回车跳转；Esc 关闭。
  - 结果仅包含用户可见对象；艺术家仅能检索到被分配任务与可见评论/批注；首屏在 300ms 内返回。
